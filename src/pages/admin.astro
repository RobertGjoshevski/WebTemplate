---
// Admin panel page that loads Decap CMS
const netlifySiteUrl = 'https://serene-rugelach-9ae7b9.netlify.app';
const identityApiUrl = `${netlifySiteUrl}/.netlify/identity`;
const base = import.meta.env.BASE_URL;
const adminUrl = `${base}/admin/`;
---

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <!-- Override Decap login: hide logo area and "Decap" text; plain text inputs only.
         We do NOT hide svg/img globally so the markdown toolbar buttons (bold, italic, etc.) stay visible. -->
    <style is:global>
      /* Hide only the login-screen logo area (first section child), not editor toolbars */
      #nc-root section > div:first-child {
        display: none !important;
      }
      #nc-root a[href*="site"],
      #nc-root a[href*="Site"] {
        display: none !important;
      }
      #nc-root input {
        padding: 10px 14px !important;
        border: 1px solid #ccc !important;
        border-radius: 6px !important;
        font-size: 16px !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }
    </style>
    <!--
      NOTE: We intentionally do NOT load the Netlify Identity Widget by default.
      Decap CMS has a built-in GoTrue client that works with identity_url from
      config.yml. Loading the external widget causes Decap CMS to re-initialize
      it without APIUrl, making it default to the page origin (github.io) which
      has no Identity service. Without the widget, Decap CMS shows its own
      email/password form and connects directly to the correct endpoint.

      The widget is loaded dynamically only for invite/recovery token handling.
    -->
  </head>
  <body>
    <a
      href={base || '/'}
      class="admin-back-link"
      aria-label="Back to website"
    >
      ← Back to website
    </a>
    <div id="nc-root"></div>
    <style is:global>
      body { margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
      /* Back link is first in column (document flow), not overlay */
      .admin-back-link {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        height: 48px;
        padding: 0 1.25rem;
        background: #1a1a1a;
        color: #fff;
        text-decoration: none;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.15);
      }
      .admin-back-link:hover {
        background: #252525;
        color: #fff;
      }
      #nc-root {
        flex: 1;
        box-sizing: border-box;
        min-height: 0;
      }
      #nc-root > * {
        box-sizing: border-box;
      }
      /* Decap CMS editor toolbar: reduce height from 66px to 50px */
      #nc-root [class*="ToolbarContainer"] {
        height: 50px !important;
      }
    </style>
    <!--
      Token handler: must run BEFORE Decap CMS, because Decap rewrites the
      hash to "#/" which destroys the invite/recovery token.
      If a token is present we handle it here and never load Decap CMS.
    -->
    <script is:inline define:vars={{ identityApiUrl, adminUrl, netlifySiteUrl, base }}>
      (function () {
        var hash = window.location.hash || '';
        // Handle both #invite_token=... and #/invite_token=...
        var inviteMatch  = hash.match(/invite_token=([^&]+)/);
        var recoveryMatch = hash.match(/recovery_token=([^&]+)/);

        if (!inviteMatch && !recoveryMatch) return; // no token — let Decap CMS load normally

        var token = inviteMatch ? inviteMatch[1] : recoveryMatch[1];
        var isInvite = !!inviteMatch;

        // Show loading state
        document.body.innerHTML = '<a href="' + (base || '/') + '" style="position:fixed;top:0;left:0;right:0;z-index:9999;display:flex;align-items:center;padding:0.75rem 1.25rem;background:#1a1a1a;color:#fff;text-decoration:none;font-family:system-ui;font-size:0.875rem">← Back to website</a>'
          + '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:system-ui">'
          + '<p>' + (isInvite ? 'Accepting invitation…' : 'Loading password reset…') + '</p></div>';

        // Stop the page from loading Decap CMS
        window.__skipDecapCMS = true;

        // Dynamically load the Netlify Identity Widget (only needed for tokens)
        var widgetScript = document.createElement('script');
        widgetScript.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
        widgetScript.onload = function () {
          initAndHandle();
        };
        document.head.appendChild(widgetScript);

        function initAndHandle() {
          if (!window.netlifyIdentity || typeof window.netlifyIdentity.init !== 'function') {
            setTimeout(initAndHandle, 100);
            return;
          }
          window.netlifyIdentity.init({ APIUrl: identityApiUrl });
          handleToken();
        }

        function handleToken() {
          if (!window.netlifyIdentity || !window.netlifyIdentity.gotrue) {
            setTimeout(handleToken, 100);
            return;
          }

          var gotrue = window.netlifyIdentity.gotrue;

          if (isInvite) {
            // Show a password form — GoTrue acceptInvite requires a password string
            document.body.innerHTML = '<a href="' + (base || '/') + '" style="position:fixed;top:0;left:0;right:0;z-index:9999;display:flex;align-items:center;padding:0.75rem 1.25rem;background:#1a1a1a;color:#fff;text-decoration:none;font-family:system-ui;font-size:0.875rem">← Back to website</a>'
              + '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:system-ui;gap:16px;max-width:400px;margin:0 auto;padding:20px;padding-top:4rem">'
              + '<h2 style="margin:0">Accept Invitation</h2>'
              + '<p style="margin:0;color:#666;text-align:center">Set a password for your new account</p>'
              + '<form id="invite-form" style="display:flex;flex-direction:column;gap:12px;width:100%">'
              + '<input id="invite-password" type="password" placeholder="Choose a password" required minlength="6" style="padding:10px 14px;border:1px solid #ccc;border-radius:6px;font-size:16px" />'
              + '<input id="invite-password-confirm" type="password" placeholder="Confirm password" required minlength="6" style="padding:10px 14px;border:1px solid #ccc;border-radius:6px;font-size:16px" />'
              + '<button type="submit" style="padding:10px 24px;background:#000;color:#fff;border:none;border-radius:6px;font-size:16px;cursor:pointer">Create Account</button>'
              + '<p id="invite-error" style="color:red;margin:0;display:none"></p>'
              + '</form>'
              + '</div>';

            document.getElementById('invite-form').addEventListener('submit', function (e) {
              e.preventDefault();
              var pw = document.getElementById('invite-password').value;
              var pw2 = document.getElementById('invite-password-confirm').value;
              var errEl = document.getElementById('invite-error');

              if (pw !== pw2) {
                errEl.textContent = 'Passwords do not match.';
                errEl.style.display = 'block';
                return;
              }
              if (pw.length < 6) {
                errEl.textContent = 'Password must be at least 6 characters.';
                errEl.style.display = 'block';
                return;
              }
              errEl.style.display = 'none';

              gotrue.acceptInvite(token, pw)
                .then(function () {
                  document.body.innerHTML = '<a href="' + (base || '/') + '" style="position:fixed;top:0;left:0;right:0;z-index:9999;display:flex;align-items:center;padding:0.75rem 1.25rem;background:#1a1a1a;color:#fff;text-decoration:none;font-family:system-ui;font-size:0.875rem">← Back to website</a>'
                    + '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:system-ui;gap:16px;padding-top:4rem">'
                    + '<h2>Account Created!</h2>'
                    + '<p>You can now log in to the admin panel.</p>'
                    + '<a href="' + adminUrl + '" style="padding:10px 24px;background:#000;color:#fff;border-radius:6px;text-decoration:none;font-size:16px">Go to Admin Panel</a>'
                    + '</div>';
                })
                .catch(function (err) {
                  errEl.textContent = err.message || 'Error accepting invitation. The token may be expired.';
                  errEl.style.display = 'block';
                });
            });
          } else {
            // Recovery — open the Identity widget which handles recovery_token natively
            window.location.hash = '#recovery_token=' + token;
            window.netlifyIdentity.init({ APIUrl: identityApiUrl });
            window.netlifyIdentity.open();
          }
        }
      })();
    </script>

    <!--
      Decap CMS — only loads when there is NO invite/recovery token.
      Uses built-in GoTrue client (no Identity widget needed).
    -->
    <script is:inline define:vars={{ netlifySiteUrl }}>
      if (!window.__skipDecapCMS) {
        // Set the Netlify site URL in localStorage so Decap CMS's built-in
        // GoTrue client knows where to find the Identity endpoint.
        // The git-gateway backend reads: localStorage.getItem('netlifySiteURL')
        localStorage.setItem('netlifySiteURL', netlifySiteUrl);

        // Dynamically load Decap CMS
        var s = document.createElement('script');
        s.src = 'https://unpkg.com/decap-cms@3.0.0/dist/decap-cms.js';
        document.body.appendChild(s);

        (function hideDecapBranding() {
          function run() {
            var root = document.getElementById('nc-root');
            if (!root) return;
            root.querySelectorAll('*').forEach(function (el) {
              if (el.children.length) return;
              var text = (el.textContent || '').trim();
              if (text === 'Decap' || text === 'Decap CMS' || text.indexOf('Decap') === 0) {
                el.style.setProperty('display', 'none', 'important');
              }
            });
          }
          setTimeout(run, 500);
          setTimeout(run, 1500);
          var obs = new MutationObserver(run);
          obs.observe(document.body, { childList: true, subtree: true });
          setTimeout(function () { obs.disconnect(); }, 5000);
        })();
      }
    </script>
  </body>
</html>
