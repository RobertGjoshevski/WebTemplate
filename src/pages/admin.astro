---
// Admin panel page that loads Decap CMS
const netlifySiteUrl = 'https://serene-rugelach-9ae7b9.netlify.app';
const identityApiUrl = `${netlifySiteUrl}/.netlify/identity`;
const base = import.meta.env.BASE_URL;
const adminUrl = `${base}/admin/`;
---

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <!-- Netlify Identity Widget from CDN - must use is:inline so Astro doesn't bundle it -->
    <script is:inline src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- Initialize Identity BEFORE Decap CMS loads (Decap calls currentUser() on init) -->
    <script is:inline define:vars={{ identityApiUrl }}>
      (function waitAndInit() {
        if (window.netlifyIdentity && typeof window.netlifyIdentity.init === 'function') {
          window.netlifyIdentity.init({ APIUrl: identityApiUrl });
        } else {
          setTimeout(waitAndInit, 50);
        }
      })();
    </script>
  </head>
  <body>
    <!-- Decap CMS - must use is:inline so Astro doesn't bundle it -->
    <script is:inline src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <!-- Handle invite/recovery tokens and login redirect -->
    <script is:inline define:vars={{ identityApiUrl, adminUrl }}>
      var hash = window.location.hash;
      var hasInvite = hash.includes('invite_token=');
      var hasRecovery = hash.includes('recovery_token=');

      function waitForIdentity(cb) {
        if (window.netlifyIdentity && typeof window.netlifyIdentity.open === 'function') {
          cb();
        } else {
          setTimeout(function() { waitForIdentity(cb); }, 100);
        }
      }

      if (hasInvite || hasRecovery) {
        waitForIdentity(function() {
          // Ensure Identity is initialized
          if (typeof window.netlifyIdentity.init === 'function') {
            window.netlifyIdentity.init({ APIUrl: identityApiUrl });
          }
          // Open the appropriate modal â€” the widget reads the token from the URL hash
          if (hasInvite) {
            window.netlifyIdentity.open('invite');
          } else {
            window.netlifyIdentity.open('recover');
          }
        });
      }

      // After any successful login, redirect to admin
      waitForIdentity(function() {
        window.netlifyIdentity.on('login', function() {
          document.location.href = adminUrl;
        });
      });
    </script>
  </body>
</html>
