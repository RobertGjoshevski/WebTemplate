---
// Admin panel page that loads Decap CMS
const netlifySiteUrl = 'https://serene-rugelach-9ae7b9.netlify.app';
const base = import.meta.env.BASE_URL;
---

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <!-- Netlify Identity widget - loads from your Netlify site to avoid CORS -->
    <script is:inline src={`${netlifySiteUrl}/.netlify/identity`}></script>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script is:inline>
      // Handle invite and recovery tokens from Netlify Identity
      function extractToken(hash, tokenName) {
        // Handle both #invite_token=... and #/invite_token=... formats
        const patterns = [
          tokenName + '=',
          '/' + tokenName + '=',
          '#' + tokenName + '=',
          '#/' + tokenName + '='
        ];
        
        for (const pattern of patterns) {
          if (hash.includes(pattern)) {
            const token = hash.split(pattern)[1];
            if (token) {
              // Extract token (remove &, #, or end of string)
              return token.split('&')[0].split('#')[0].split('?')[0];
            }
          }
        }
        return null;
      }
      
      const hash = window.location.hash || window.location.href.split('#')[1] || '';
      const inviteToken = extractToken(hash, 'invite_token');
      const recoveryToken = extractToken(hash, 'recovery_token');
      
      const adminUrl = '{base}/admin/';
      
      // Wait for Netlify Identity to load
      function handleIdentity() {
        if (!window.netlifyIdentity) {
          // Retry after a short delay if not loaded yet
          setTimeout(handleIdentity, 100);
          return;
        }
        
        // Initialize Netlify Identity
        window.netlifyIdentity.on('init', (user) => {
          console.log('Netlify Identity initialized', { user, inviteToken, recoveryToken });
          
          // If there's an invite token, accept it
          if (inviteToken && !user) {
            console.log('Accepting invitation with token:', inviteToken);
            window.netlifyIdentity.acceptInvite(inviteToken)
              .then(() => {
                console.log('Invitation accepted successfully');
                // Clear the hash and reload
                window.location.hash = '';
                window.location.reload();
              })
              .catch((err) => {
                console.error('Error accepting invite:', err);
                alert('Error accepting invitation. Please try again or contact the administrator.');
                // Clear hash anyway
                window.location.hash = '';
              });
            return; // Don't proceed with other handlers
          }
          
          // If there's a recovery token, handle password reset
          if (recoveryToken && !user) {
            // Recovery token is handled by Netlify Identity widget automatically
            // The widget will show password reset form when it detects recovery_token
            console.log('Recovery token detected, showing password reset form');
            return;
          }
          
          // Handle login redirect
          if (!user && !inviteToken && !recoveryToken) {
            window.netlifyIdentity.on('login', () => {
              document.location.href = adminUrl;
            });
          }
        });
        
        // Also try to open the widget if there's a token
        if (inviteToken || recoveryToken) {
          // Give it a moment for the widget to initialize
          setTimeout(() => {
            if (inviteToken && !window.netlifyIdentity.currentUser()) {
              console.log('Opening identity widget for invite');
              window.netlifyIdentity.open('invite');
            }
          }, 500);
        }
      }
      
      // Start handling identity
      handleIdentity();
    </script>
  </body>
</html>
