---
// Admin panel page that loads Decap CMS
const netlifySiteUrl = 'https://serene-rugelach-9ae7b9.netlify.app';
const base = import.meta.env.BASE_URL;
---

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <!-- Netlify Identity widget - loads from your Netlify site to avoid CORS -->
    <script is:inline src={`${netlifySiteUrl}/.netlify/identity`}></script>
    <script is:inline>
      // Set API URL before Identity loads
      window.netlifyIdentity = window.netlifyIdentity || {};
      window.netlifyIdentity.on = window.netlifyIdentity.on || function() {};
    </script>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script is:inline>
      // Handle invite and recovery tokens from Netlify Identity
      // Handle both #invite_token=... and #/invite_token=... formats
      const hash = window.location.hash;
      
      // Extract invite token (handle both #invite_token= and #/invite_token=)
      let inviteToken = null;
      if (hash.includes('invite_token=')) {
        const parts = hash.split('invite_token=');
        if (parts.length > 1) {
          inviteToken = parts[1].split('&')[0].split('#')[0]; // Get token, remove any trailing hash or params
        }
      }
      
      // Extract recovery token
      let recoveryToken = null;
      if (hash.includes('recovery_token=')) {
        const parts = hash.split('recovery_token=');
        if (parts.length > 1) {
          recoveryToken = parts[1].split('&')[0].split('#')[0];
        }
      }
      
      const adminUrl = '{base}/admin/';
      
      console.log('Hash:', hash);
      console.log('Invite token:', inviteToken);
      console.log('Recovery token:', recoveryToken);
      
      // Wait for Netlify Identity to load and initialize
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds max wait
      
      function handleIdentity() {
        attempts++;
        
        // Check if Identity widget is loaded (has the open method)
        if (!window.netlifyIdentity || typeof window.netlifyIdentity.open !== 'function') {
          if (attempts < maxAttempts) {
            console.log('Waiting for Netlify Identity...', attempts);
            setTimeout(handleIdentity, 100);
            return;
          } else {
            console.error('Netlify Identity failed to load after', attempts, 'attempts');
            alert('Failed to load authentication. Please refresh the page.');
            return;
          }
        }
        
        console.log('Netlify Identity loaded successfully');
        
        // Initialize Netlify Identity with the API URL
        if (typeof window.netlifyIdentity.init === 'function') {
          window.netlifyIdentity.init({
            APIUrl: '${netlifySiteUrl}/.netlify/identity'
          });
        }
        
        // Set up the init event handler
        window.netlifyIdentity.on('init', (user) => {
          console.log('Identity initialized, user:', user);
          
          // If there's an invite token, open the invite modal
          // Netlify Identity will automatically show the password setup form
          if (inviteToken && !user) {
            console.log('Opening invite modal with token:', inviteToken);
            // Open the invite modal - Netlify Identity will handle the token from the URL
            window.netlifyIdentity.open('invite');
            return; // Don't proceed with other handlers
          }
          
          // If there's a recovery token, open the recovery modal
          if (recoveryToken && !user) {
            console.log('Opening recovery modal');
            window.netlifyIdentity.open('recover');
            return;
          }
          
          // Handle login redirect
          if (!user && !inviteToken && !recoveryToken) {
            window.netlifyIdentity.on('login', () => {
              document.location.href = adminUrl;
            });
          }
        });
        
        // Also check if identity is already initialized
        try {
          const currentUser = window.netlifyIdentity.currentUser();
          console.log('Current user check:', currentUser);
          
          // If we have a token and no user, open the appropriate modal
          if (inviteToken && !currentUser) {
            console.log('Opening invite modal immediately');
            window.netlifyIdentity.open('invite');
          } else if (recoveryToken && !currentUser) {
            console.log('Opening recovery modal immediately');
            window.netlifyIdentity.open('recover');
          }
        } catch (e) {
          console.log('Error checking current user:', e);
        }
      }
      
      // Start handling identity
      handleIdentity();
    </script>
  </body>
</html>
