---
// Admin panel page that loads Decap CMS
const netlifySiteUrl = 'https://serene-rugelach-9ae7b9.netlify.app';
const identityApiUrl = `${netlifySiteUrl}/.netlify/identity`;
const base = import.meta.env.BASE_URL;
const adminUrl = `${base}/admin/`;
---

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <!-- Netlify Identity Widget from CDN — is:inline prevents Astro from bundling it -->
    <script is:inline src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <!--
      Token handler: must run BEFORE Decap CMS, because Decap rewrites the
      hash to "#/" which destroys the invite/recovery token.
      If a token is present we handle it here and never load Decap CMS.
    -->
    <script is:inline define:vars={{ identityApiUrl, adminUrl }}>
      (function () {
        var hash = window.location.hash || '';
        // Handle both #invite_token=... and #/invite_token=...
        var inviteMatch  = hash.match(/invite_token=([^&]+)/);
        var recoveryMatch = hash.match(/recovery_token=([^&]+)/);

        if (!inviteMatch && !recoveryMatch) return; // no token — let Decap CMS load normally

        var token = inviteMatch ? inviteMatch[1] : recoveryMatch[1];
        var isInvite = !!inviteMatch;

        // Hide "Loading configuration..." that Decap would show
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:system-ui">'
          + '<p>' + (isInvite ? 'Accepting invitation…' : 'Loading password reset…') + '</p></div>';

        // Stop the page from loading Decap CMS (we'll set a flag)
        window.__skipDecapCMS = true;

        // Use GoTrue-JS (bundled inside the Identity widget) to accept the invite
        function handleToken() {
          if (!window.netlifyIdentity || !window.netlifyIdentity.gotrue) {
            setTimeout(handleToken, 100);
            return;
          }

          var gotrue = window.netlifyIdentity.gotrue;

          if (isInvite) {
            // Show a password form — GoTrue acceptInvite requires a password string
            document.body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:system-ui;gap:16px;max-width:400px;margin:0 auto;padding:20px">'
              + '<h2 style="margin:0">Accept Invitation</h2>'
              + '<p style="margin:0;color:#666;text-align:center">Set a password for your new account</p>'
              + '<form id="invite-form" style="display:flex;flex-direction:column;gap:12px;width:100%">'
              + '<input id="invite-password" type="password" placeholder="Choose a password" required minlength="6" style="padding:10px 14px;border:1px solid #ccc;border-radius:6px;font-size:16px" />'
              + '<input id="invite-password-confirm" type="password" placeholder="Confirm password" required minlength="6" style="padding:10px 14px;border:1px solid #ccc;border-radius:6px;font-size:16px" />'
              + '<button type="submit" style="padding:10px 24px;background:#000;color:#fff;border:none;border-radius:6px;font-size:16px;cursor:pointer">Create Account</button>'
              + '<p id="invite-error" style="color:red;margin:0;display:none"></p>'
              + '</form>'
              + '</div>';

            document.getElementById('invite-form').addEventListener('submit', function (e) {
              e.preventDefault();
              var pw = document.getElementById('invite-password').value;
              var pw2 = document.getElementById('invite-password-confirm').value;
              var errEl = document.getElementById('invite-error');

              if (pw !== pw2) {
                errEl.textContent = 'Passwords do not match.';
                errEl.style.display = 'block';
                return;
              }
              if (pw.length < 6) {
                errEl.textContent = 'Password must be at least 6 characters.';
                errEl.style.display = 'block';
                return;
              }
              errEl.style.display = 'none';

              gotrue.acceptInvite(token, pw)
                .then(function () {
                  document.body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:system-ui;gap:16px">'
                    + '<h2>Account Created!</h2>'
                    + '<p>You can now log in to the admin panel.</p>'
                    + '<a href="' + adminUrl + '" style="padding:10px 24px;background:#000;color:#fff;border-radius:6px;text-decoration:none;font-size:16px">Go to Admin Panel</a>'
                    + '</div>';
                })
                .catch(function (err) {
                  errEl.textContent = err.message || 'Error accepting invitation. The token may be expired.';
                  errEl.style.display = 'block';
                });
            });
          } else {
            // Recovery — open the Identity widget which handles recovery_token natively
            // We need to set the hash so the widget can read it
            window.location.hash = '#recovery_token=' + token;
            // Initialize and open the widget
            window.netlifyIdentity.init({ APIUrl: identityApiUrl });
            window.netlifyIdentity.open();
          }
        }

        // Initialize Identity widget first, then handle token
        function initAndHandle() {
          if (!window.netlifyIdentity || typeof window.netlifyIdentity.init !== 'function') {
            setTimeout(initAndHandle, 100);
            return;
          }
          window.netlifyIdentity.init({ APIUrl: identityApiUrl });
          handleToken();
        }
        initAndHandle();
      })();
    </script>

    <!--
      Decap CMS — only loads when there is NO invite/recovery token.
      is:inline prevents Astro from bundling the CDN script.
    -->
    <script is:inline define:vars={{ identityApiUrl, adminUrl, netlifySiteUrl }}>
      if (!window.__skipDecapCMS) {
        // Set the Netlify site URL in localStorage so the Identity widget
        // (and Decap CMS's own re-initialization) finds the correct endpoint.
        // The widget reads this key to know which Identity instance to talk to.
        localStorage.setItem('netlifySiteURL', netlifySiteUrl);

        // Initialize Identity for Decap CMS (it calls currentUser() on boot)
        (function initForDecap() {
          if (window.netlifyIdentity && typeof window.netlifyIdentity.init === 'function') {
            window.netlifyIdentity.init({ APIUrl: identityApiUrl });
            // Redirect after login
            window.netlifyIdentity.on('login', function () {
              document.location.href = adminUrl;
            });
          } else {
            setTimeout(initForDecap, 50);
          }
        })();

        // Dynamically load Decap CMS
        var s = document.createElement('script');
        s.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
        document.body.appendChild(s);
      }
    </script>
  </body>
</html>
