---
import { getCollection } from 'astro:content';
import { BlogCarousel } from './BlogCarousel';

const blogPosts = await getCollection('blog', ({ data }) => {
  return true;
});

// Sort by date, newest first
const sortedPosts = blogPosts.sort((a, b) =>
  b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

// Use Astro's base URL to handle the /WebTemplate base path
const base = import.meta.env.BASE_URL;

// Ensure hero image paths include base when they're local paths (e.g. /images/uploads/...)
function resolveImageSrc(src: string): string {
  if (!src || src.startsWith('http')) return src;
  if (src.startsWith(base)) return src;
  if (src.startsWith('/')) return base.replace(/\/$/, '') + src;
  return src;
}

// Serialize posts for the carousel (React island)
const carouselPosts = sortedPosts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  heroImage: post.data.heroImage ? resolveImageSrc(post.data.heroImage) : null,
  pubDate: post.data.pubDate.toISOString(),
}));
---

<section class="container mx-auto px-4 py-16">
  <h2 class="text-3xl font-bold text-center mb-12">Latest Posts</h2>
  {sortedPosts.length > 0 ? (
    <BlogCarousel client:load posts={carouselPosts} base={base} />
  ) : (
    <p class="text-center text-muted-foreground">
      No blog posts yet. Create your first post in the admin panel!
    </p>
  )}
</section>
